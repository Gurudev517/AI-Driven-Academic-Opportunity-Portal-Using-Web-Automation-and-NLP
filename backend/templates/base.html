<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Academic Portal | Research Opportunities</title>
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.10.0/font/bootstrap-icons.css">
    <link rel="stylesheet" href="{{ url_for('static', filename='style.css') }}">

    <style>
        /* ===== NAVBAR ===== */
        nav { 
            background: white; padding: 20px 80px; display: flex; 
            justify-content: space-between; box-shadow: 0 2px 10px rgba(0,0,0,0.05); 
            position: sticky; top: 0; z-index: 100;
        }
        .nav-links a { margin-left: 25px; text-decoration: none; color: #475569; font-weight: 600; font-size: 15px; }
        .nav-links a:hover { color: #2563eb; }
        .logo { font-weight: 800; font-size: 20px; color: #0f172a; text-decoration: none; }

        /* ===== CHATBOT STYLES ===== */
        .chat-btn {
            position: fixed; bottom: 30px; right: 30px; width: 60px; height: 60px;
            background: linear-gradient(135deg, #0d6efd, #0a58ca); color: white;
            border: none; border-radius: 50%; box-shadow: 0 4px 15px rgba(0,0,0,0.3);
            z-index: 9999; cursor: pointer; transition: transform 0.3s ease;
            display: flex; align-items: center; justify-content: center;
        }
        .chat-btn:hover { transform: scale(1.1); }
        
        .chat-window {
            display: none; position: fixed; bottom: 100px; right: 30px; width: 350px; height: 450px;
            background: white; border-radius: 15px; box-shadow: 0 5px 25px rgba(0,0,0,0.2);
            z-index: 9999; flex-direction: column; overflow: hidden; border: 1px solid #e0e0e0;
        }
        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(10px); }
            to { opacity: 1; transform: translateY(0); }
        }

        /* Responsive Grid Fixes */
        @media (max-width: 1200px) { .filters-grid { grid-template-columns: repeat(4, 1fr) !important; } }
        @media (max-width: 992px) { .filters-grid { grid-template-columns: repeat(3, 1fr) !important; } }
        @media (max-width: 768px) { .filters-grid { grid-template-columns: repeat(2, 1fr) !important; } }
        @media (max-width: 480px) { .filters-grid { grid-template-columns: 1fr !important; } }
    </style>
</head>

<body>
    <nav>
        <a href="/" class="logo">AcademicPortal</a>
        <div class="nav-links">
            <a href="/">Dashboard</a>
            <a href="/search">Manual Search</a>
            <a href="/matcher">AI Matcher</a>
            <a href="/roadmap">Skill Roadmap</a>
        </div>
    </nav>

    {% block content %}{% endblock %}

    <button id="chat-launcher" class="chat-btn" onclick="toggleChat()">
        <i class="bi bi-chat-dots-fill" style="font-size: 28px;"></i>
    </button>

    <div id="chat-window" class="chat-window">
        <div style="background: #0d6efd; color: white; padding: 15px; display: flex; align-items: center; justify-content: space-between;">
            <div style="display: flex; align-items: center; gap: 10px;">
                <div style="width: 10px; height: 10px; background: #00ff88; border-radius: 50%;"></div>
                <span style="font-weight: bold; font-size: 16px;">AI Research Assistant</span>
            </div>
            <button onclick="toggleChat()" style="background: none; border: none; color: white; font-size: 20px; cursor: pointer;">&times;</button>
        </div>

        <div id="chat-messages" style="flex: 1; padding: 15px; overflow-y: auto; background: #f8f9fa;"></div>

        <div style="padding: 15px; background: white; border-top: 1px solid #eee; display: flex; align-items: center;">
            <input type="text" id="user-input" placeholder="Type your query..." 
                   style="flex: 1; border: 1px solid #ced4da; padding: 8px 12px; border-radius: 20px; outline: none; font-size: 14px;">
            <button onclick="sendMessage()" 
                    style="background: #0d6efd; color: white; border: none; width: 35px; height: 35px; border-radius: 50%; margin-left: 10px; cursor: pointer; display: flex; align-items: center; justify-content: center;">
                <i class="bi bi-send-fill" style="font-size: 14px;"></i>
            </button>
        </div>
    </div>
    <script>
        // --- 1. TYPEWRITER EFFECT (Your Original Feature) ---
        const words = ["Internships", "Opportunities", "Research", "Careers"];
        let wordIndex = 0, charIndex = 0, isDeleting = false;

        function typeEffect() {
            const target = document.getElementById("typewriter");
            if (!target) return;
            const currentWord = words[wordIndex];
            target.textContent = isDeleting ? currentWord.substring(0, charIndex - 1) : currentWord.substring(0, charIndex + 1);
            charIndex = isDeleting ? charIndex - 1 : charIndex + 1;
            let typeSpeed = isDeleting ? 60 : 150;
            if (!isDeleting && charIndex === currentWord.length) { typeSpeed = 2000; isDeleting = true; } 
            else if (isDeleting && charIndex === 0) { isDeleting = false; wordIndex = (wordIndex + 1) % words.length; typeSpeed = 500; }
            setTimeout(typeEffect, typeSpeed);
        }
        document.addEventListener("DOMContentLoaded", typeEffect);

        // --- 2. CHATBOT LOGIC (New Feature) ---
        let firstOpen = true; 

        function toggleChat() {
            const win = document.getElementById('chat-window');
            const btn = document.getElementById('chat-launcher');
            
            if (win.style.display === 'none' || win.style.display === '') {
                win.style.display = 'flex';
                btn.style.transform = 'scale(0.9)';
                if (firstOpen) {
                    runWelcomeSequence();
                    firstOpen = false;
                }
            } else {
                win.style.display = 'none';
                btn.style.transform = 'scale(1)';
            }
        }

        function runWelcomeSequence() {
            const introMessages = [
                "Hi there! ðŸ‘‹ I am your AI Research Assistant.",
                "I scan listings from IITs & NITs to help you find the perfect research role.",
                "Try asking: <b>'Find Python jobs'</b> or <b>'Show IITM'</b>."
            ];
            introMessages.forEach((msg, index) => {
                setTimeout(() => { addBotMessage(msg); }, (index + 1) * 1000);
            });
        }

        function addBotMessage(text) {
            const messages = document.getElementById('chat-messages');
            messages.innerHTML += `
                <div style="display: flex; margin-bottom: 10px; animation: fadeIn 0.3s;">
                    <div style="background: #e9ecef; color: #212529; padding: 10px 14px; border-radius: 15px 15px 15px 0; font-size: 14px; max-width: 85%; box-shadow: 0 1px 2px rgba(0,0,0,0.1);">
                        ${text}
                    </div>
                </div>`;
            messages.scrollTop = messages.scrollHeight;
        }

        async function sendMessage() {
            const input = document.getElementById('user-input');
            const messages = document.getElementById('chat-messages');
            const text = input.value.trim();
            if (!text) return;

            // Add User Message
            messages.innerHTML += `
                <div style="display: flex; justify-content: flex-end; margin-bottom: 10px; animation: fadeIn 0.3s;">
                    <div style="background: #0d6efd; color: white; padding: 10px 14px; border-radius: 15px 15px 0 15px; font-size: 14px; max-width: 85%;">
                        ${text}
                    </div>
                </div>`;
            input.value = '';
            messages.scrollTop = messages.scrollHeight;

            // Add Loader
            const loadingId = 'loading-' + Date.now();
            messages.innerHTML += `
                <div id="${loadingId}" style="display: flex; margin-bottom: 10px;">
                    <div style="background: #e9ecef; color: #6c757d; padding: 8px 12px; border-radius: 15px 15px 15px 0; font-size: 12px;">
                        Thinking...
                    </div>
                </div>`;
            messages.scrollTop = messages.scrollHeight;

            try {
                const resp = await fetch('/chat', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ message: text })
                });
                const data = await resp.json();
                document.getElementById(loadingId).remove();
                addBotMessage(data.response);
            } catch (err) {
                document.getElementById(loadingId).innerHTML = "Error connecting to server.";
            }
        }

        // Allow 'Enter' key to send
        document.getElementById('user-input').addEventListener('keypress', function (e) {
            if (e.key === 'Enter') sendMessage();
        });
    </script>
</body>
</html>